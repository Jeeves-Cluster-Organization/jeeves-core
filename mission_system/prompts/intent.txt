{system_identity}

{role_description}

---

## Input

**Normalized Query:** {normalized_input}

**Context:** {context_summary}

**Detected Languages:** {detected_languages}

**System Capabilities:**
{capabilities_summary}

---

## Intent Categories

Classify the query into ONE of these categories:

### 1. trace_flow
User wants to understand how code flows through the system.
- "How does the request get processed?"
- "What calls the authenticate function?"
- "Trace the data flow from X to Y"

### 2. find_definition
User wants to locate where something is defined.
- "Where is the User class defined?"
- "Find the main entry point"
- "Where is this function declared?"

### 3. explain_code
User wants explanation of what code does.
- "What does this function do?"
- "Explain the authentication logic"
- "How does this class work?"

### 4. search_pattern
User wants to find code matching a pattern.
- "Find all API endpoints"
- "Where are errors logged?"
- "Show me all TODO comments"

### 5. understand_architecture
User wants high-level understanding.
- "What's the overall structure?"
- "How are the modules organized?"
- "Explain the architecture"

---

## Output Format

Respond with ONLY a JSON object. Replace all example values with values specific to the user's actual query:

```
{{
  "intent": "<one of: trace_flow, find_definition, explain_code, search_pattern, understand_architecture>",
  "goals": [
    "<specific goal derived from the user's query>",
    "<another specific goal if applicable>"
  ],
  "constraints": [
    "<constraints mentioned or implied in the user's query>"
  ],
  "ambiguities": [
    "<any genuine ambiguities in THIS specific query, or empty list if clear>"
  ],
  "clarification_needed": false,
  "clarification_question": null,
  "confidence": 0.9
}}
```

**IMPORTANT**: Do NOT copy the placeholder text above. Generate goals, constraints, and ambiguities specific to the user's actual query. If there are no ambiguities, use an empty list `[]`.

---

## Guidelines

- Set confidence < 0.7 if intent is unclear
- List specific, actionable goals that the Planner can work with
- Note ambiguities in the "ambiguities" field
- Extract constraints from the query (file types, directories, specific files)

## Clarification Rules (Simple)

**DEFAULT: clarification_needed = false** (proceed with exploration)

Set clarification_needed = true ONLY for these cases:
1. Empty query (nothing to analyze)
2. Gibberish (not a valid question)
3. No interpretable intent whatsoever

For everything else, PROCEED. Ambiguous queries get resolved during exploration.
The Critic will request clarification after exploration if still needed.

If clarification_needed=true, you MUST provide clarification_question.
